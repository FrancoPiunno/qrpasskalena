<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Generador de QR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="shortcut icon" type="x-icon" href="{{ url_for('static', filename='webicon.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>@import url('https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap');</style>
</head>
<body>
  <div class="nav">
    <a href="{{ url_for('index') }}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#000000" d="M341.8 72.6C329.5 61.2 310.5 61.2 298.3 72.6L74.3 280.6C64.7 289.6 61.5 303.5 66.3 315.7C71.1 327.9 82.8 336 96 336L112 336L112 512C112 547.3 140.7 576 176 576L464 576C499.3 576 528 547.3 528 512L528 336L544 336C557.2 336 569 327.9 573.8 315.7C578.6 303.5 575.4 289.5 565.8 280.6L341.8 72.6zM304 384L336 384C362.5 384 384 405.5 384 432L384 528L256 528L256 432C256 405.5 277.5 384 304 384z"/></svg></a>
    <a href="{{ url_for('logout') }}" class="btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#ffffff" d="M224 160C241.7 160 256 145.7 256 128C256 110.3 241.7 96 224 96L160 96C107 96 64 139 64 192L64 448C64 501 107 544 160 544L224 544C241.7 544 256 529.7 256 512C256 494.3 241.7 480 224 480L160 480C142.3 480 128 465.7 128 448L128 192C128 174.3 142.3 160 160 160L224 160zM566.6 342.6C579.1 330.1 579.1 309.8 566.6 297.3L438.6 169.3C426.1 156.8 405.8 156.8 393.3 169.3C380.8 181.8 380.8 202.1 393.3 214.6L466.7 288L256 288C238.3 288 224 302.3 224 320C224 337.7 238.3 352 256 352L466.7 352L393.3 425.4C380.8 437.9 380.8 458.2 393.3 470.7C405.8 483.2 426.1 483.2 438.6 470.7L566.6 342.7z"/></svg></a>
  </div>
  
  <div class="gencon">
    <div class="description">
      <img src="{{ url_for('static', filename='sellokalenablanco.png') }}" alt="Logo">
      <div class="descriptiontest">
        <h1>QR Pass</h1>
        <p>Completa la información para generar el QR.</p>
      </div>
    </div>
    <form method="POST" class="formulario">
      <div class="inputs">
        <!-- Selección de evento -->
        <div class="mb-3">
          <select name="evento" class="form-control" required>
            <option value="">Seleccione un evento</option>
            {% for ev in eventos %}
              <option value="{{ ev.nombre }}">{{ ev.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <!-- Nombre de la persona -->
        <div class="mb-3">
          <input type="text" name="nombre" class="form-control" required placeholder="Nombre/Apellido de la Persona">
        </div>
        <!-- Teléfono -->
        <div class="mb-3">
          <input type="text" name="telefono" class="form-control" required placeholder="Teléfono">
        </div>
      </div>
      <div class="genbuttons">
        <a href="{{ url_for('lista_entradas') }}" style="text-decoration: none;"><button type="button">Lista</button></a>
        <button type="submit">Generar</button>
      </div>
    </form>

  {% if qr_base64 %}
    <div class="mt-4">
      <h4>QR generado</h4>
      <div class="mt-3">
        <p><strong>Evento:</strong> {{ evento }}</p>
        <p><strong>Nombre:</strong> {{ nombre }}</p>
        <p><strong>Teléfono:</strong> {{ telefono }}</p>
      </div>
      <div class="share">
        <a href="{{ url_for('descargar_qr', id=qr_id) }}" class="qrdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 306.7L246.6 265.3C234.1 252.8 213.8 252.8 201.3 265.3C188.8 277.8 188.8 298.1 201.3 310.6L297.3 406.6C309.8 419.1 330.1 419.1 342.6 406.6L438.6 310.6C451.1 298.1 451.1 277.8 438.6 265.3C426.1 252.8 405.8 252.8 393.3 265.3L352 306.7L352 96zM160 384C124.7 384 96 412.7 96 448L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 448C544 412.7 515.3 384 480 384L433.1 384L376.5 440.6C345.3 471.8 294.6 471.8 263.4 440.6L206.9 384L160 384zM464 440C477.3 440 488 450.7 488 464C488 477.3 477.3 488 464 488C450.7 488 440 477.3 440 464C440 450.7 450.7 440 464 440z"/></svg></a>
        <a href="#" class="qrdown"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="100" height="100" viewBox="0 0 30 30" onclick="sharePngWithText(event)"><path d="M 15 3 C 8.373 3 3 8.373 3 15 C 3 17.251208 3.6323415 19.350068 4.7109375 21.150391 L 3.1074219 27 L 9.0820312 25.431641 C 10.829354 26.425062 12.84649 27 15 27 C 21.627 27 27 21.627 27 15 C 27 8.373 21.627 3 15 3 z M 10.892578 9.4023438 C 11.087578 9.4023438 11.287937 9.4011562 11.460938 9.4101562 C 11.674938 9.4151563 11.907859 9.4308281 12.130859 9.9238281 C 12.395859 10.509828 12.972875 11.979906 13.046875 12.128906 C 13.120875 12.277906 13.173313 12.453437 13.070312 12.648438 C 12.972312 12.848437 12.921344 12.969484 12.777344 13.146484 C 12.628344 13.318484 12.465078 13.532109 12.330078 13.662109 C 12.181078 13.811109 12.027219 13.974484 12.199219 14.271484 C 12.371219 14.568484 12.968563 15.542125 13.851562 16.328125 C 14.986562 17.342125 15.944188 17.653734 16.242188 17.802734 C 16.540187 17.951734 16.712766 17.928516 16.884766 17.728516 C 17.061766 17.533516 17.628125 16.864406 17.828125 16.566406 C 18.023125 16.268406 18.222188 16.319969 18.492188 16.417969 C 18.766188 16.515969 20.227391 17.235766 20.525391 17.384766 C 20.823391 17.533766 21.01875 17.607516 21.09375 17.728516 C 21.17075 17.853516 21.170828 18.448578 20.923828 19.142578 C 20.676828 19.835578 19.463922 20.505734 18.919922 20.552734 C 18.370922 20.603734 17.858562 20.7995 15.351562 19.8125 C 12.327563 18.6215 10.420484 15.524219 10.271484 15.324219 C 10.122484 15.129219 9.0605469 13.713906 9.0605469 12.253906 C 9.0605469 10.788906 9.8286563 10.071437 10.097656 9.7734375 C 10.371656 9.4754375 10.692578 9.4023438 10.892578 9.4023438 z"></path></svg></a>
      </div>
      </div>
  {% endif %}
  </div>

<script>
  async function sharePngWithText(e) {
    e.preventDefault();

    // Datos para el mensaje
    const evento   = `{{ evento|e }}`;
    const nombre   = `{{ nombre|e }}`;
    const telefono = `{{ telefono|e }}`;
    const verifyUrl = `{{ verify_url or '' }}`;

    const text = [
      `Evento: ${evento}`,
      `Nombre: ${nombre}`,
      `Teléfono: ${telefono}`,
      verifyUrl ? `Verificar: ${verifyUrl}` : null
    ].filter(Boolean).join("\n");

    // 1) Conseguir el PNG como Blob
    let blob;
    const b64 = `{{ qr_base64 or '' }}`;
    try {
      if (b64) {
        // Usar la imagen ya renderizada (más rápido)
        const dataUrl = `data:image/png;base64,${b64}`;
        const res = await fetch(dataUrl);
        blob = await res.blob();
      } else {
        // O descargarla desde tu endpoint
        const res = await fetch(`{{ url_for('descargar_qr', id=qr_id) }}`);
        blob = await res.blob();
      }
    } catch (err) {
      console.error("No pude obtener el PNG:", err);
      alert("No se pudo preparar la imagen para compartir.");
      return;
    }

    // 2) Intentar Web Share API con archivos (móviles compatibles)
    try {
      const file = new File([blob], `qr_{{ qr_id }}.png`, { type: "image/png" });
      const shareData = { title: "QR Pass", text, files: [file] };

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share(shareData);  // Abre hoja de compartir: elegís WhatsApp, contacto, y manda imagen+texto
        return;
      }
    } catch (err) {
      // Usuario canceló o no soportado: seguimos al fallback
      console.warn("Share con archivo falló o cancelado:", err);
    }

    // 3) Fallback para desktop: abrir WhatsApp Web con solo texto (no adjunta imagen por limitación de la plataforma)
    const downloadUrl = `{{ url_for('descargar_qr', id=qr_id, _external=True) }}`;
    const textoWeb = text + (downloadUrl ? `\nDescargar PNG: ${downloadUrl}` : "");
    window.open(`https://web.whatsapp.com/send?text=${encodeURIComponent(textoWeb)}`, "_blank");
  }
</script>
